<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=no, user-scalable=no">
    <title>Movie Details</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="movie-content" class="container">
        <!-- Now Playing Title -->
        <p class="now-playing-title">
            <a href="index.html" class="now-playing-link">
                <img src="icons/back-arrow-3.svg" alt="Back Arrow" class="back-arrow-img">
                Now Playing
            </a>
        </p>
        <!-- Movie Trailer Section -->
        <div class="movie-poster-container" style="position: relative;">
            <!-- Video element -->
            <video id="trailer-video" playsinline muted>
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <!-- Play Button Overlay -->
            <div id="play-button-overlay" class="play-button-container">
                <img src="icons/play-button-3.svg" alt="Play Button" class="play-button">
            </div>
            <!-- Progress bar -->
            <div id="video-progress-container" style="display: none;">
                <div id="video-progress-bar"></div>
            </div>
        </div>
        <div class="header-with-back">
            <h1 id="movie-title">Loading...</h1>
        </div>
        <div id="date-showtime">
            <p id="showtime-date">Thu Dec. 26</p>
            <a href="#" class="time-link">4:30 pm</a>
        </div>
        <p id="movie-synopsis">Loading synopsis...</p>
        <div id="movie-details"></div>
    </div>
    <div id="sticky-banner">
        <!-- Sticky banner content will be dynamically updated -->
    </div>

    <script>
        const apiKey = "n06hg935gmg68bdv2526wkyjg4"; // Your API Key
        const filmApiUrl = "https://api.uswest.veezi.com/v4/film";

        async function fetchMovieDetails(filmId) {
            try {
                if (!filmId) throw new Error("No filmId provided in URL");

                const response = await fetch(`${filmApiUrl}/${filmId}`, {
                    headers: { "VeeziAccessToken": apiKey },
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch movie details: ${response.status} ${response.statusText}`);
                }

                const film = await response.json();

                // Update movie details
                document.getElementById("movie-title").textContent = film.Title || "Unknown Title";
                document.getElementById("movie-synopsis").textContent = film.Synopsis || "No synopsis available.";
                document.getElementById("movie-details").innerHTML = `
                    <p>Genre: ${film.Genre || "Unknown"}</p>
                    <p>Runtime: ${film.Duration || "Unknown"} minutes</p>
                    <p>Rating: ${film.Rating || "Not Rated"}</p>
                    <p>Director: ${
                        film.People.filter(person => person.Role === "Director")
                            .map(person => `${person.FirstName} ${person.LastName}`)
                            .join(", ") || "Unknown"
                    }</p>
                `;

                const trailerVideo = document.getElementById("trailer-video");
                const playButtonOverlay = document.getElementById("play-button-overlay");
                const videoProgressContainer = document.getElementById("video-progress-container");
                const videoProgressBar = document.getElementById("video-progress-bar");

                if (film.FilmTrailerUrl) {
                    trailerVideo.querySelector("source").src = film.FilmTrailerUrl;
                    trailerVideo.load();

                    // Play button click handler
                    playButtonOverlay.addEventListener("click", () => {
                        playButtonOverlay.style.display = "none"; // Hide the play button
                        trailerVideo.muted = false; // Unmute the video
                        trailerVideo.play(); // Play the video
                        videoProgressContainer.style.display = "block"; // Show the progress bar
                    });

                    // Update slider as the video plays
                    trailerVideo.addEventListener("timeupdate", () => {
                        if (!isNaN(trailerVideo.duration)) {
                            const progress = (trailerVideo.currentTime / trailerVideo.duration) * 100;
                            videoProgressBar.style.width = `${progress}%`;

                            // Apply rounded leading edge
                            videoProgressBar.style.borderTopRightRadius = "5px";
                            videoProgressBar.style.borderBottomRightRadius = "5px";

                            // Remove rounding at full progress
                            if (progress >= 100) {
                                videoProgressBar.style.borderTopRightRadius = "0px";
                                videoProgressBar.style.borderBottomRightRadius = "0px";
                            }
                        }
                    });

                    // Handle scrubbing (click and drag)
                    videoProgressContainer.addEventListener("mousedown", (e) => {
                        const containerWidth = videoProgressContainer.offsetWidth;
                        const offsetX = e.offsetX;
                        const scrubTime = (offsetX / containerWidth) * trailerVideo.duration;
                        trailerVideo.currentTime = scrubTime;

                        const progress = (trailerVideo.currentTime / trailerVideo.duration) * 100;
                        videoProgressBar.style.width = `${progress}%`;
                    });

                    videoProgressContainer.addEventListener("mousemove", (e) => {
                        if (e.buttons === 1) { // Only handle dragging with mouse button held
                            const containerWidth = videoProgressContainer.offsetWidth;
                            const offsetX = e.offsetX;
                            const scrubTime = (offsetX / containerWidth) * trailerVideo.duration;
                            trailerVideo.currentTime = scrubTime;

                            const progress = (trailerVideo.currentTime / trailerVideo.duration) * 100;
                            videoProgressBar.style.width = `${progress}%`;
                        }
                    });
                } else {
                    document.querySelector(".movie-poster-container").innerHTML =
                        `<p>Trailer not available.</p>`;
                }
            } catch (error) {
                console.error("Error loading movie details:", error);
                document.getElementById("movie-content").innerHTML = `<p>Error loading movie details.</p>`;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const filmId = new URLSearchParams(window.location.search).get("filmId");
            if (filmId) fetchMovieDetails(filmId);
        });
    </script>
</body>
</html>