<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="movie-content" class="container">
        <img id="movie-backdrop" src="" alt="Movie Backdrop">
        <div class="header-with-back">
            <h1 id="movie-title">Loading...</h1>
        </div>
        <div id="movie-showtimes">
            <ul id="showtimes-list">Loading showtimes...</ul>
        </div>
        <p id="movie-synopsis">Loading synopsis...</p>
        <div id="movie-details"></div>
    </div>

    <script>
        const apiKey = "n06hg935gmg68bdv2526wkyjg4"; // Your API Key
        const filmApiUrl = "https://api.uswest.veezi.com/v4/film";
        const sessionApiUrl = "https://api.uswest.veezi.com/v1/session";

        // Utility function to format a date string into "Thu Dec. 26" format
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekday = date.toLocaleDateString(undefined, { weekday: "short" });
            const month = date.toLocaleDateString(undefined, { month: "short" });
            const day = date.toLocaleDateString(undefined, { day: "2-digit" });
            return `${weekday} ${month}. ${day}`;
        }

        // Utility function to format a time string into a 12-hour clock with lowercase am/pm
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date
                .toLocaleTimeString([], { hour: "numeric", minute: "2-digit", hour12: true })
                .toLowerCase();
        }

        // Fetch movie details
        async function fetchMovieDetails(filmId) {
            try {
                if (!filmId) throw new Error("No filmId provided in URL");

                const response = await fetch(`${filmApiUrl}/${filmId}`, {
                    headers: { "VeeziAccessToken": apiKey },
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch movie details: ${response.status} ${response.statusText}`);
                }

                const film = await response.json();

                // Update movie details
                document.getElementById("movie-title").textContent = film.Title || "Unknown Title";
                document.getElementById("movie-backdrop").src =
                    film.BackdropImageUrl || "https://via.placeholder.com/800x400?text=Backdrop+Not+Available";
                document.getElementById("movie-synopsis").textContent = film.Synopsis || "No synopsis available.";
                document.getElementById("movie-details").innerHTML = `
                    <p><strong>Genre:</strong> ${film.Genre || "Unknown"}</p>
                    <p><strong>Duration:</strong> ${film.Duration || "Unknown"} minutes</p>
                    <p><strong>Rating:</strong> ${film.Rating || "Not Rated"}</p>
                    <p><strong>Opening Date:</strong> ${
                        film.OpeningDate ? formatDate(film.OpeningDate) : "Unknown"
                    }</p>
                `;
            } catch (error) {
                console.error("Error loading movie details:", error);
                document.getElementById("movie-content").innerHTML = `<p>Error loading movie details.</p>`;
            }
        }

        // Fetch showtimes for the movie
        async function fetchMovieShowtimes(filmId) {
            try {
                const response = await fetch(sessionApiUrl, {
                    headers: { "VeeziAccessToken": apiKey },
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch showtimes: ${response.status} ${response.statusText}`);
                }

                const sessions = await response.json();

                // Filter showtimes for the specific filmId
                const filteredShowtimes = sessions.filter(session => session.FilmId === filmId);

                const showtimesList = document.getElementById("showtimes-list");
                showtimesList.innerHTML = ""; // Clear the placeholder text

                if (filteredShowtimes.length === 0) {
                    showtimesList.innerHTML = "<li>No showtimes available for this movie.</li>";
                    return;
                }

                // Group showtimes by date
                const groupedByDate = {};
                filteredShowtimes.forEach(showtime => {
                    const date = formatDate(showtime.PreShowStartTime);
                    if (!groupedByDate[date]) {
                        groupedByDate[date] = [];
                    }
                    groupedByDate[date].push(showtime);
                });

                // Sort dates chronologically
                const sortedDates = Object.keys(groupedByDate).sort(
                    (a, b) => new Date(a) - new Date(b)
                );

                // Render showtimes grouped by date
                sortedDates.forEach(date => {
                    const dateItem = document.createElement("li");
                    dateItem.innerHTML = `<strong>${date}</strong>`;
                    showtimesList.appendChild(dateItem);

                    const timesContainer = document.createElement("div");
                    timesContainer.className = "showtimes-horizontal";

                    groupedByDate[date].forEach(showtime => {
                        const startTime = formatTime(showtime.PreShowStartTime);
                        const timeLink = document.createElement("a");
                        timeLink.href = `purchase.html?sessionId=${showtime.Id}`;
                        timeLink.className = "time-link";
                        timeLink.textContent = startTime;

                        timesContainer.appendChild(timeLink);
                    });

                    showtimesList.appendChild(timesContainer);
                });
            } catch (error) {
                console.error("Error loading showtimes:", error);
                document.getElementById("showtimes-list").innerHTML = "<li>Error loading showtimes.</li>";
            }
        }

        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            const filmId = new URLSearchParams(window.location.search).get("filmId");
            if (filmId) {
                fetchMovieDetails(filmId);
                fetchMovieShowtimes(filmId);
            } else {
                document.getElementById("movie-content").innerHTML = `<p>No movie selected.</p>`;
            }
        });
    </script>
</body>
</html>